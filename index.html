<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ロボットコージョー ガチャ</title>
  <style>
    :root {
      --bg1:#2d333b;
      --bg2:#3c434c;
      --card:#111b29;
      --card-got:#f8fbff;
      --card-locked:#000000;
      --text:#eaf6ff;
      --text-dark:#0b1a2c;
      --muted:#7fa0c7;
      --accent:#4de1ff;
      --metal-light:#eef0f3;
      --metal-mid:#9ba1aa;
      --metal-dark:#2e333a;
    }
    body {
      margin:0; font-family: "Yu Gothic UI", "Yu Gothic", "Meiryo", "Noto Sans JP", "Segoe UI", system-ui, -apple-system, sans-serif; color: var(--text);
      background:
        radial-gradient(circle at 50% 40%, rgba(90,100,110,0.12), transparent 34%),
        radial-gradient(circle at 50% 60%, rgba(60,70,80,0.10), transparent 40%),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.015) 0 1px, transparent 1px 4px),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.015) 0 1px, transparent 1px 4px),
        linear-gradient(180deg, #3c434c, #2d333b);
      background-color: #2d333b;
      min-height:100vh;
    }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 30px 24px 60px; position:relative; }
    h1 { font-size: 20px; margin: 0 0 16px; font-weight: 800; letter-spacing:.04em; color: var(--text); text-shadow: 0 0 14px rgba(77,225,255,.25); position:relative; z-index:2; }

    /* 外装 */
    .machine-shell { position: relative; padding: 42px 36px 56px; background: linear-gradient(180deg, #5a6068 0%, #3c4149 100%); border-radius: 22px; box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -4px 10px rgba(0,0,0,.35), 0 18px 32px rgba(0,0,0,.55), 0 0 30px rgba(0,0,0,.45); overflow: visible; }
    .machine-shell::before, .machine-shell::after { content:""; position:absolute; left:0; right:0; border-radius: 18px; pointer-events:none; }
    .machine-shell::before { top:-110px; height: 100px; width: 68%; margin: 0 auto; background: linear-gradient(180deg, #666e78 0%, #4a525c 60%, #353b44 100%); box-shadow: inset 0 1px 0 rgba(255,255,255,.35), inset 0 -3px 8px rgba(0,0,0,.4), 0 14px 22px rgba(0,0,0,.45); border: 1px solid rgba(0,0,0,.35); }
    .machine-shell::after { bottom:-70px; height: 68px; width: 92%; margin: 0 auto; background: linear-gradient(180deg, var(--metal-dark) 0%, #1d2127 100%); box-shadow: inset 0 1px 0 rgba(255,255,255,.25), inset 0 -2px 6px rgba(0,0,0,.5), 0 -6px 12px rgba(0,0,0,.35); border: 1px solid rgba(0,0,0,.45); }
    .hazard-bar { position:absolute; bottom:-38px; left:50%; transform: translateX(-50%); width: 320px; height: 18px; border-radius: 6px; background: repeating-linear-gradient(135deg, #f7c500 0 14px, #22252b 14px 26px); box-shadow: inset 0 1px 0 rgba(255,255,255,.4), 0 4px 10px rgba(0,0,0,.45); z-index:4; }
    .side-panel { position:absolute; top:30px; bottom:30px; width: 72px; background: linear-gradient(180deg, var(--metal-light) 0%, #cfd3d8 45%, var(--metal-mid) 100%); border: 1px solid rgba(0,0,0,.35); box-shadow: inset 0 1px 0 rgba(255,255,255,.5), inset 0 -3px 6px rgba(0,0,0,.35); z-index:1; }
    .side-panel.left { left:-40px; border-radius: 18px 0 0 18px; }
    .side-panel.right { right:-40px; border-radius: 0 18px 18px 0; }
    .side-window { position:absolute; top:80px; bottom:120px; left:12px; right:12px; background: linear-gradient(180deg, #4c525a 0%, #2f343c 100%); border-radius: 12px; box-shadow: inset 0 1px 0 rgba(255,255,255,.25), inset 0 -3px 8px rgba(0,0,0,.4); }

    /* 内側（モニター） */
    .panel { background: linear-gradient(180deg, #242b34, #1a1f27); border: 1px solid rgba(77,225,255,.25); border-radius: 14px; padding: 20px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 18px 32px rgba(0,0,0,.45); position: relative; overflow:hidden; z-index:3; }
    .panel::before { content:""; position:absolute; inset:0; background: repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0 1px, transparent 1px 3px); mix-blend-mode: screen; opacity:.6; pointer-events:none; }
    .monitor-bar { background: linear-gradient(180deg, rgba(15,26,43,0.9), rgba(9,14,23,0.9)); border: 1px solid rgba(77,225,255,.25); border-radius: 12px; padding: 12px 14px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 0 18px rgba(77,225,255,.15); display:flex; gap:12px; flex-wrap: wrap; align-items:center; }
    .monitor-btn { position: relative; padding: 11px 16px; border: 1px solid rgba(77,225,255,.45); background: linear-gradient(180deg, rgba(77,225,255,.25), rgba(77,225,255,.10)); color: var(--text); font-weight: 800; letter-spacing:.05em; cursor:pointer; border-radius: 10px; box-shadow: 0 0 12px rgba(77,225,255,.35), inset 0 1px 0 rgba(255,255,255,.12); text-transform: uppercase; transition: transform .08s ease, box-shadow .08s ease; }
    .monitor-btn:hover { transform: translateY(-1px); box-shadow: 0 0 16px rgba(77,225,255,.5), inset 0 1px 0 rgba(255,255,255,.18); }
    .monitor-btn:active { transform: translateY(0); box-shadow: 0 0 10px rgba(77,225,255,.4); }
    .monitor-btn:disabled { opacity:.45; cursor:not-allowed; transform:none; box-shadow: 0 0 8px rgba(77,225,255,.2); }

    .monitor-screen { position: relative; margin-top: 16px; padding: 18px; border-radius: 20px; background: linear-gradient(180deg, #6c747f, #2f333a); box-shadow: inset 0 3px 0 rgba(255,255,255,.35), inset 0 -4px 10px rgba(0,0,0,.45), 0 18px 40px rgba(0,0,0,.55); overflow:hidden; }
    .monitor-bezel { position: relative; background: linear-gradient(180deg, #1c2028, #0f131a); border-radius: 14px; padding: 14px 14px 56px; border: 2px solid #0c0f15; box-shadow: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -2px 6px rgba(0,0,0,.5), 0 0 0 1px rgba(0,0,0,.4); }
    .monitor-bezel::before, .monitor-bezel::after { content:""; position:absolute; width:10px; height:10px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff, #9aa5b5 50%, #3a4450 80%); box-shadow: inset 0 1px 0 rgba(255,255,255,.4); }
    .monitor-bezel::before { top:10px; left:10px; }
    .monitor-bezel::after { top:10px; right:10px; }
    .screen-inner { position: relative; border-radius: 10px; background: radial-gradient(circle at 20% 20%, rgba(77,225,255,.08), transparent 45%), radial-gradient(circle at 80% 30%, rgba(136,255,186,.06), transparent 45%), linear-gradient(180deg, rgba(12,20,31,.95), rgba(10,15,24,.96)); min-height: 420px; box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), inset 0 0 0 2px rgba(0,0,0,.6); overflow:hidden; border: 3px solid #181c24; display:flex; align-items:center; justify-content:center; }
        .screen-noise {
      position:absolute; inset:0; pointer-events:none; mix-blend-mode: screen;
      background-image:
        repeating-linear-gradient(0deg, rgba(255,255,255,0.12) 0 1px, transparent 1px 2px),
        repeating-linear-gradient(90deg, rgba(255,255,255,0.08) 0 1px, transparent 1px 3px),
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.12), transparent 42%),
        radial-gradient(circle at 80% 60%, rgba(255,255,255,0.08), transparent 46%);
      opacity:.72;
      animation: noiseScroll 1.2s linear infinite;
    }
    @keyframes noiseScroll { 0% { background-position: 0 0, 0 0, 0 0; } 100% { background-position: 0 40px, 0 12px, 0 -24px; } }
    .console { position:absolute; left:14px; right:14px; bottom:12px; height: 56px; background: linear-gradient(180deg, #1b2027, #0e1118); border: 1px solid rgba(0,0,0,.6); border-radius: 10px; box-shadow: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -2px 5px rgba(0,0,0,.5); display:flex; align-items:center; gap:10px; padding: 6px 10px; }
    .console .lamp { width:18px; height:18px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff, currentColor 55%, #111 100%); box-shadow: 0 0 8px currentColor, inset 0 1px 1px rgba(255,255,255,.5); }
    .console .lamp.red { color:#e86a6a; }
    .console .lamp.green { color:#7ee07a; }
    .console .lamp.amber { color:#e6c05e; }
    .console .lamp.blue { color:#63c7ff; }
    .console .volume { display:flex; align-items:center; gap:8px; width: 190px; }
    .console .volume label { font-size: 12px; color: var(--muted); }
    .console input[type=range] { flex:1; -webkit-appearance: none; height:8px; border-radius: 6px; background: linear-gradient(180deg, #d1d6de, #8c94a0); box-shadow: inset 0 1px 0 rgba(255,255,255,.6), inset 0 -1px 2px rgba(0,0,0,.3); }
    .console input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width:16px; height:16px; border-radius:50%; background: linear-gradient(180deg, #6cc7ff, #2f6b9c); box-shadow: 0 2px 4px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.7); }
    .console input[type=range]::-moz-range-thumb { width:16px; height:16px; border-radius:50%; background: linear-gradient(180deg, #6cc7ff, #2f6b9c); box-shadow: 0 2px 4px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.7); border: none; }
    .console .toggle { padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background: linear-gradient(180deg, #2b313a, #1a1f27); color: var(--text); font-size: 12px; cursor:pointer; box-shadow: inset 0 1px 0 rgba(255,255,255,.18), 0 2px 6px rgba(0,0,0,.35); }

    .result { position: relative; z-index: 1; display:flex; align-items:center; justify-content:center; min-height: 420px; padding: 14px; }
    .card { box-sizing: border-box; width: 100%; max-width: 720px; padding: 14px; border-radius: 12px; border: 1px solid rgba(77,225,255,.15); background: var(--card); box-shadow: 0 12px 28px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.04); transition: box-shadow .15s ease, transform .15s ease; }
    .card.with-image { display:grid; grid-template-columns: 1fr; gap:12px; align-items: stretch; }
    @media (min-width: 760px) { .card.with-image { grid-template-columns: 260px 1fr; } }
        .card.got { background: var(--card-got); border-color: rgba(136,255,186,.35); box-shadow: 0 12px 30px rgba(0,0,0,.3); color: var(--text-dark); }
    .history .card { box-sizing: border-box; width:100%; max-width:none; transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease; cursor:pointer; }
    .history .card:hover { transform: translateY(-2px); box-shadow: 0 16px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(77,225,255,.22); border-color: rgba(77,225,255,.25); }
    .card.locked { background: var(--card-locked); border-color: rgba(255,255,255,.06); color:#dfe5f0; box-shadow: 0 10px 24px rgba(0,0,0,.35); }
    .thumb { border-radius: 10px; overflow: hidden; background: linear-gradient(145deg, #182330, #0f1824); border: 1px solid rgba(77,225,255,.18); display:flex; align-items:center; justify-content:center; padding: 6px; }
    .card.got .thumb { background: #fff; border-color: rgba(0,0,0,.08); }
    .card.locked .thumb { background: #000; border-color:#222835; color:#7fa0c7; }
    .thumb img { width: 100%; height: 320px; object-fit: contain; display:block; }
    .thumb.small { width: 120px; height: 120px; padding: 5px; margin: 0 auto; }
    .thumb.small img { max-height: 110px; width: 100%; height: 100%; object-fit: contain; }
    .thumb-empty { display:flex; align-items:center; justify-content:center; color: var(--muted); font-size: 12px; }
    .item { font-size: 16px; font-weight: 800; margin: 6px 0 6px; letter-spacing:.02em; }
    .card.locked .item { color:#dfe5f0; }
    .desc { color: var(--muted); font-size: 13px; line-height: 1.6; }
    .card.locked .desc { color:#9aa6bb; }
    .meta { margin-top: 8px; display:flex; gap:12px; flex-wrap: wrap; color: var(--muted); font-size: 12px; }

    /* 図鑑モニター */
    .dex-monitor { margin-top:22px; background: linear-gradient(180deg, #4a5565, #1a2230); border: 10px solid rgba(77,225,255,.35); border-radius: 16px; box-shadow: inset 0 3px 0 rgba(255,255,255,.18), 0 18px 40px rgba(0,0,0,.4); }
    .dex-header { padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,.08); background: linear-gradient(180deg, rgba(77,225,255,.15), rgba(0,0,0,.25)); }
    .dex-title { font-size: 13px; font-weight: 800; letter-spacing:.08em; color: var(--muted); text-shadow: 0 0 10px rgba(77,225,255,.25); }
    .dex-body { max-height: 360px; overflow-y: auto; padding: 16px; background: linear-gradient(180deg, rgba(12,20,31,.95), rgba(10,15,24,.96)); }
    .dex-body::-webkit-scrollbar { width: 8px; }
    .dex-body::-webkit-scrollbar-thumb { background: rgba(77,225,255,.35); border-radius: 8px; }
    .dex-body::-webkit-scrollbar-track { background: rgba(255,255,255,.05); }
    .history { margin-top: 0; position:relative; z-index:1; }
    .list { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .history-row { display:grid; gap:8px; align-items:flex-start; }
    .small { font-size: 12px; color: var(--muted); }
    .card.locked .small { color:#97a4ba; }
    .badge { display:inline-block; padding: 3px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; letter-spacing:.03em; }
    .badge.got { background: rgba(136,255,186,.18); border:1px solid rgba(136,255,186,.5); color:#0d4224; }
    .badge.locked { background: rgba(77,225,255,.12); border:1px solid rgba(77,225,255,.35); color:#c9e8ff; }
    .actions { margin-top: 8px; display:flex; gap:10px; flex-wrap: wrap; font-size: 12px; }
    .actions a, .actions button { color: #0f6bdc; text-decoration: none; border:1px solid #7ac0ff; padding:6px 10px; border-radius:8px; background:#eef6ff; font-weight:700; box-shadow: inset 0 1px 0 #fff; cursor:pointer; }
    .actions a:hover, .actions button:hover { background: #d9ecff; }

    .stats { color: var(--muted); font-size: 12px; font-weight: 700; letter-spacing:.02em; text-shadow: 0 0 8px rgba(77,225,255,.2); }
    @keyframes drawPulse { 0% { transform: scale(0.98); box-shadow: 0 0 0 0 rgba(77,225,255,.5); } 40% { transform: scale(1.01); box-shadow: 0 0 0 12px rgba(77,225,255,.0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(77,225,255,.0); } }
    .draw-anim { animation: drawPulse .85s ease; }

    .modal { position: fixed; inset:0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal.show { display:flex; animation: modalIn .25s ease; }
    .modal-content { max-width: min(90vw, 900px); max-height: min(90vh, 900px); background: #0b0f18; border: 2px solid rgba(77,225,255,.4); border-radius: 12px; padding: 10px; box-shadow: 0 16px 40px rgba(0,0,0,.6), 0 0 24px rgba(77,225,255,.25); transform: scale(0.96); animation: popIn .25s ease forwards; }
    .modal-content img { width: 100%; height: 100%; object-fit: contain; display:block; background: #fff; }
    @keyframes popIn { from { transform: scale(0.9); opacity:0; } to { transform: scale(1); opacity:1; } }
    @keyframes modalIn { from { background: rgba(0,0,0,0); } to { background: rgba(0,0,0,0.6); } }
      .ground { height: 120px; background: #fff; }
    @keyframes shakeX { 0% { transform: translateX(0); } 25% { transform: translateX(-6px); } 50% { transform: translateX(6px); } 75% { transform: translateX(-6px); } 100% { transform: translateX(0); } }
    .history .card.shake { animation: shakeX 0.32s ease; }
</style>
</head>
<body>
  <audio id="bgm" src="bgm/bgm1.mp3" loop></audio>
  <audio id="se1" src="se/se1.mp3" preload="auto"></audio>
  <audio id="se2" src="se/se2.mp3" preload="auto"></audio>
  <audio id="sa4" src="se/sa4.mp3" preload="auto"></audio>
  <audio id="se3" src="se/se3.mp3" preload="auto"></audio>
  <audio id="se5" src="se/se5.mp3" preload="auto"></audio>
  <audio id="se6" src="se/se6.mp3" preload="auto"></audio>
  <audio id="se4" src="se/se4.mp3" preload="auto"></audio>
  <audio id="se7" src="se/se7.mp3" preload="auto"></audio>
  <div class="wrap">
    <h1>ロボットコージョー ガチャ</h1>

    <div class="machine-shell">
      <div class="side-panel left"><div class="side-window"></div></div>
      <div class="side-panel right"><div class="side-window"></div></div>
      <div class="hazard-bar"></div>

      <div class="panel">
        <div class="monitor-bar">
          <button class="monitor-btn" id="drawBtn">作る</button>
          <span class="stats">引いた数: <span id="count">0</span> / <span id="total">0</span></span>
          <span class="stats">残り: <span id="left">0</span></span>
        </div>

        <div class="monitor-screen">
          <div class="monitor-bezel">
            <div class="screen-inner">
              <div class="screen-noise"></div>
              <div class="result" id="result"></div>
            </div>
            <div class="console">
              <div class="lamp red"></div>
              <div class="lamp amber"></div>
              <div class="lamp green"></div>
              <div class="lamp blue"></div>
              <button class="toggle" id="bgmToggle">BGM: ON</button>
              <div class="volume">
                <label for="vol">音量</label>
                <input type="range" id="vol" min="0" max="1" step="0.01" value="0.4" />
              </div>
              <div class="keys">
                <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
                <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span>
              </div>
            </div>
          </div>
        </div>

        <div class="dex-monitor">
          <div class="dex-header"><span class="dex-title">図鑑</span></div>
          <div class="dex-body">
            <div class="history"><div class="list" id="history"></div></div>
          </div>
        </div>
      </div>
    </div>

    <p class="small" style="margin-top:24px">
      これはクライアントだけで動く簡易ガチャです。全て引くと終了します。画像は入手済みカードからダウンロードできます。
    </p>
  </div>
  <div class="modal" id="modal">
    <div class="modal-content">
      <img id="modalImg" src="" alt="">
    </div>
  </div>

<script>  const FILES = ["Wide Adachi Walking.png","YO! SAY夏が胸を刺激する足立.png","────という事なんですが…….png","「今日は一日雨ですね」.png","『とりま聞こう？』.png","あ…あの奇天烈な動き…！.png","ああいあうあえあおあんいいういえいおいんううえうおうんええおえんおおんん.wav.png","あいたたた….png","あなた.png","あらららら….png","あれれ.png","あれれれ….png","あれ？さっきまでここに…どこ行った？.png","いくぞ～.png","うわっ！.png","うんちつんつん足立.png","こっちの方がいいかな.png","これかぁ～？.png","これか？.png","これもいいなぁ.png","さし.png","しゃがみ.png","そいやっそいやっ.png","そこそこ遠…トホホ.png","そこどこ？.png","どっせいどっせい.png","ぬき.png","ばいばーい足立.png","ふーん…ワクワク….png","ぽっぴぽっぴぽっぽっぴっぽー右足立.png","ぽっぴぽっぴぽっぽっぴっぽー左足立.png","わたしにも血液はあります.png","アン＝ダン＝チ＝レイ.png","イェーイ足立.png","サボテンダー足立.png","スパイダーレイ.png","スピニングバードキック！.png","スンッ….png","セクシー足立.png","ニコーー.png","バッター足立.png","パーティションはないない足立.png","フィラメント残量切れで途中までしか出力されなかった個体.png","ホッ！ハッ！ヤッ！.png","メカニカルガール足立.png","モデルさん足立.png","ヨガフロート足立.png","ライトニング・ボルト足立.png","ロケット足立.png","ワクワク.png","充電中足立.png","別に食べれないことないけどさ.png","君の幸運を祈る.png","固定ミスでずれて出力された個体.png","変わった人間もいるんですね.png","外出た瞬間終わった足立.png","岐阜の足立.png","幕引きだ！.png","引きこもり絶対ジャスティス足立.png","待ち足立.png","日進月歩遭難中.png","朝まで寝よーーーーーーーーっと！！.png","歌う足立.png","波動拳！.png","畳み掛ける！.png","目新しい音探して三千里.png","空N足立.png","立ち強p足立.png","管理・処理室.png","素材テストで出力された個体.png","美味しくなーれ！.png","荒ぶる鷹の足立.png","走り足立1.png","走り足立2.png","走り足立3.png","走り足立4.png","足(右).png","足(左).png","足立はダンスにハマってる？.png","首狩り族右足立.png","首狩り族左足立.png","鳴り止まないこの音楽を…….png","ﾚｲﾀﾞﾖｰ.png" ];

  const ITEMS = FILES.map(file => ({ name: file.replace(/\.png$/i, ""), desc: "", img: "images/" + file }));

  const LS_DRAWN = "gacha_drawn_map_v1";
  const LS_COUNT = "gacha_count_v3";
  localStorage.removeItem(LS_DRAWN);
  localStorage.removeItem(LS_COUNT);

  const loadDrawn = () => { try { return JSON.parse(localStorage.getItem(LS_DRAWN) || "{}"); } catch { return {}; } };
  const saveDrawn = (obj) => localStorage.setItem(LS_DRAWN, JSON.stringify(obj));
  const loadCount = () => Number(localStorage.getItem(LS_COUNT) || "0");
  const saveCount = (n) => localStorage.setItem(LS_COUNT, String(n));

  const randInt = (max) => { const a = new Uint32Array(1); crypto.getRandomValues(a); return a[0] % max; };
  const pickAvailable = (drawnMap) => { const available = ITEMS.filter(x => !(x.name in drawnMap)); if (!available.length) return null; return available[randInt(available.length)]; };

  const escapeHtml = (s = "") => s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
      const playSound = (id, volume = 0.7) => {
    const el = document.getElementById(id);
    if (!el) return;
    try {
      const clone = el.cloneNode(true);
      clone.volume = volume;
      clone.currentTime = 0;
      clone.play();
    } catch (_) {}
  };
  const imageBlock = (item, size = "lg") => {
    if (!item || !item.img) return "";
    const cls = size === "sm" ? "thumb small" : "thumb";
    const src = escapeHtml(item.img);
    const alt = escapeHtml(item.name || "item image");
    return `<div class="${cls}"><img src="${src}" alt="${alt}" loading="lazy"></div>`;
  };

  const render = () => {
    const drawnMap = loadDrawn();
    const drawnCount = Object.keys(drawnMap).length;
    const remaining = ITEMS.length - drawnCount;
    document.getElementById("count").textContent = drawnCount;
    document.getElementById("left").textContent = remaining;
    document.getElementById("total").textContent = ITEMS.length;

    document.getElementById("history").innerHTML = ITEMS.map(item => {
      const gotAt = drawnMap[item.name];
      const got = Boolean(gotAt);
      const displayName = got ? item.name : "???";
      const badge = got ? `<span class="badge got">入手済</span>` : `<span class="badge locked">未入手</span>`;
      const actions = "";
      const attr = got ? `data-img="${escapeHtml(item.img)}" data-name="${escapeHtml(item.name)}"` : "";
      return `
        <div class="card ${got ? "got" : "locked"} history-card" ${attr}>
          <div class="history-row">
            ${imageBlock(item, "sm")}
            <div>
              <div class="item" style="margin:0 0 4px;">${escapeHtml(displayName)}</div>
              <div class="small">${badge}</div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    const btn = document.getElementById("drawBtn");
    btn.disabled = remaining === 0;
    if (remaining === 0) {
      document.getElementById("result").innerHTML = `<div class="card"><div class="small">コンプリートしました！履歴からダウンロードできます。</div></div>`;
    } else if (!document.getElementById("result").children.length) {
      document.getElementById("result").innerHTML = `<div class="small">引くボタンでガチャを回してください。</div>`;
    }
  };

    const scrollToHistory = (name) => {
    const body = document.querySelector('.dex-body');
    if (!body || !name) return;
    const card = [...body.querySelectorAll('.history-card')].find(c => c.getAttribute('data-name') === name);
    if (!card) return;
    const bodyRect = body.getBoundingClientRect();
    const cardRect = card.getBoundingClientRect();
    const top = cardRect.top - bodyRect.top + body.scrollTop - 8;
    body.scrollTo({ top, behavior: 'smooth' });
  };

  const drawOnce = () => {
    const drawnMap = loadDrawn();
    const item = pickAvailable(drawnMap);
    if (!item) { render(); return; }

    const at = Date.now();
    drawnMap[item.name] = at;
    saveDrawn(drawnMap);

    const cnt = loadCount() + 1;
    saveCount(cnt);

    const resultEl = document.getElementById("result");
    resultEl.innerHTML = 
      `<div class="card with-image got">
        ${imageBlock(item)}
        <div>
          <div class="item">${escapeHtml(item.name)}</div>
          <div class="meta">
            <span>回数… ${cnt} 回</span>
            <span>時刻… ${new Date(at).toLocaleString()}</span>
          </div>
          
        </div>
      </div>`;
    const card = resultEl.querySelector('.card');
    if (card) {
      card.classList.add('draw-anim');
      setTimeout(() => card.classList.remove('draw-anim'), 900);
    }

    render();
    scrollToHistory(item.name);
  };

      const drawBtn = document.getElementById("drawBtn");
  drawBtn.addEventListener("mouseover", () => playSound("se3", 0.65));
  drawBtn.addEventListener("click", () => {
    playSound("se6", 0.8);
    drawOnce();
  });

  // 拡大表示
  const modal = document.getElementById("modal");
  const modalImg = document.getElementById("modalImg");
  modal.addEventListener("click", () => {
    modal.classList.remove("show");
    modalImg.src = "";
  });
    const historyEl = document.getElementById("history");
  let hoverCard = null;
  historyEl.addEventListener("mouseover", (e) => {
    const card = e.target.closest(".history-card");
    if (!card || hoverCard === card) return;
    hoverCard = card;
    const got = card.classList.contains("got");
    playSound(got ? "se1" : "se2", 0.45);
  });
  historyEl.addEventListener("mouseleave", () => { hoverCard = null; });
  historyEl.addEventListener("click", (e) => {
    const card = e.target.closest(".history-card");
    if (!card) return;
    const got = card.classList.contains("got");
    if (got) {
      playSound("sa4", 0.7);
      const img = card.getAttribute("data-img");
      if (!img) return;
      playSound("se4", 0.65);
      modalImg.src = img;
      modal.classList.add("show");
    } else {
      playSound("se5", 0.75);
      card.classList.remove("shake");
      void card.offsetWidth;
      card.classList.add("shake");
    }
  });

  const dexBody = document.querySelector('.dex-body');
  if (dexBody) {
    dexBody.addEventListener('wheel', (e) => {
      const speed = Math.min(1, Math.abs(e.deltaY) / 400);
      const volume = 0.05 + 0.12 * speed;
      playSound('se7', volume);
    }, { passive: true });
  }
// BGMループと音量・オンオフ
  const bgm = document.getElementById("bgm");
  const vol = document.getElementById("vol");
  const bgmToggle = document.getElementById("bgmToggle");
  let bgmOn = true;

  const updateLabel = () => { if (bgmToggle) bgmToggle.textContent = bgmOn ? "BGM: ON" : "BGM: OFF"; };

  const ensurePlay = async () => {
    if (!bgm) return;
    bgm.loop = true;
    bgm.volume = Number(vol?.value || 0.4);
    bgm.playbackRate = 1;
    try { await bgm.play(); } catch (_) { /* autoplay ブロック時は無視 */ }
  };

  if (bgm) {
    bgm.addEventListener("timeupdate", () => {
      if (bgm.duration && bgm.currentTime > bgm.duration - 0.12) {
        bgm.currentTime = 0;
        bgm.play();
      }
    });
    bgm.addEventListener("ended", () => { bgm.currentTime = 0; bgm.play(); });
  }

  vol?.addEventListener("input", () => { if (bgm) bgm.volume = Number(vol.value || 0.4); });
  bgmToggle?.addEventListener("click", () => { bgmOn = !bgmOn; updateLabel(); if (!bgm) return; if (bgmOn) { ensurePlay(); } else { bgm.pause(); } });
  document.addEventListener("click", () => ensurePlay(), { once:true });
  updateLabel();
  ensurePlay();

  render();</script>
</body>
</html>






























































